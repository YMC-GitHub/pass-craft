## 镜像构建

### 开发时构建
```bash
# docker build -f Dockerfile.alpine.dev -t pass-craft:dev --target development .
docker build -f Dockerfile -t pass-craft:dev --target development .


# USE_CHINA_MIRROR
docker build --target development --build-arg USE_CHINA_MIRROR=true -t pass-craft:dev .

# docker build --target development -f Dockerfile.alpine -t pass-craft:dev .
```

### 生产时构建
```bash
# 在docker中为alpine平台构建
# ./scripts/local-build-scratch-in-docker.sh build_only --use-mirror --target runtime-alpine --tag alpine

# uc1:
# 构建scratch镜像
./scripts/local-build-scratch-in-docker.sh build_only --china-mirror --target runtime --tag scratch --rust-mirror ustc

# 给scratch标签镜像添加latest标签作为最小标签
docker tag pass-craft:scratch pass-craft:latest

# 使用alpine 为运行时作为 latest
./scripts/local-build-scratch-in-docker.sh extract --china-mirror --target runtime --tag scratch
docker build -f Dockerfile.alpine -t pass-craft:alpine .

```

## 镜像查看
```bash
docker images  --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 10

docker images --filter "reference=*/*" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 10

docker images --filter "reference=pass-craft" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 10

# pass-craft   dev       2.19GB

# docker history yemiancheng/poetry-bookworm:cn-deploy
```

## 镜像大小对比
```
REPOSITORY   TAG       SIZE
pass-craft   scratch   1.26MB
pass-craft   latest    12.7MB
pass-craft   dev       1.79GB
```

## 镜像运行
```bash
docker run --rm pass-craft:latest --help || echo "容器正常启动"

# 服务状态检测 表格 
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 10

# 检查容器状态
docker ps -f name=pass-craft

# 查看容器日志
docker logs pass-craft

# 进入容器检查
docker exec -it pass-craft /bin/sh

# 检查健康状态
docker inspect --format='{{.State.Health.Status}}' pass-craft
```

## 容器停止
```bash
# 停止所有运行中的 pass-craft 容器
docker stop $(docker ps -a | grep pass-craft | awk '{print $1}')

# docker stop $(docker ps -a  | awk '{print $1}')
```

## 容器删除
```bash
# 删除所有 pass-craft 容器
docker rm $(docker ps -a | grep pass-craft | awk '{print $1}')

# docker ps -a | grep -E "(cloudflare|inspiring|youthful)"
```

## 镜像删除
```bash
# 删除无名镜像
docker rmi $(docker images -f "dangling=true" -q)

# 删除所有 pass-craft 镜像
docker rmi $(docker images | grep pass-craft | awk '{print $3}')

# 除了 dev 标签外，删除所有 pass-craft 镜像
docker rmi $(docker images | grep pass-craft | grep -v dev | awk '{print $3}')

# 除了 dev 或 scratch 标签外，删除所有 pass-craft 镜像
docker rmi $(docker images | grep pass-craft | grep -v dev | grep -v scratch | grep -v optimized | awk '{print $3}')

# 除了 dev 或 scratch 标签外，删除所有 pass-craft 镜像（通过仓库和标签名）
docker rmi $(docker images | grep pass-craft | grep -v dev | grep -v scratch | grep -v optimized | awk '{print $1 ":" $2}')

docker rmi $(docker images | grep pass-craft | grep -v dev | grep -v scratch | grep -v optimized | awk '{print $1 ":" $2}')


docker rmi $(docker images | grep pass-craft | grep -v dev | grep -v scratch | grep -v latest | awk '{print $1 ":" $2}')


# docker rmi $(docker images | grep pass-craft | grep scratch | awk '{print $1 ":" $2}')


# docker rmi pass-craft:dev
# docker rmi pass-craft-pass-craft-dev:latest

```

## 镜像发布
```bash
docker build -f Dockerfile.docker.client -t docker-client .

docker run -it --rm --env-file .env  -v /var/run/docker.sock:/var/run/docker.sock -w /app -v ./scripts:/app/scripts docker-client sh

# list image
docker images

# 
# ls scripts
chmod +x ./scripts/push-docker-io.sh
# ls ./scripts/push-docker-io.sh

sh ./scripts/push-docker-io.sh
```

## 应用运行

### docker 版
```bash
bin="docker run --rm pass-craft:latest";
# bin="docker run --rm pass-craft:scratch";
# bin="docker run --rm pass-craft:alpine";

$bin --help
$bin --version
$bin --show-platform

# docker run --rm pass-craft:alpine --sslf "name:john,email:john@gmail.com,site:john.com,;method:sha512,cut:8,end:+,upper-start:5" --save passwords.example.md;
# docker run --rm pass-craft:latest --sslf "name:john,email:john@gmail.com,site:john.com,;method:sha512,cut:8,end:+,upper-start:5" --save passwords.example.md;


docker run --rm -v $(pwd):/app:rw --user $(id -u):$(id -g) pass-craft:alpine --file passwords.example.md --save passwords.example.md --show-config
docker run --rm -v $(pwd):/app:rw --user $(id -u):$(id -g) pass-craft:alpine --file passwords.example.md --save passwords.example.md

docker run --rm -v $(pwd):/app:rw --user $(id -u):$(id -g) pass-craft:latest --file passwords.example.md --save passwords.example.md --show-config
docker run --rm -v $(pwd):/app:rw --user $(id -u):$(id -g) pass-craft:latest --file passwords.example.md --save passwords.example.md

docker run --rm -v $(pwd):/app pass-craft:latest --file passwords.example.md --save passwords.example.md --show-config
docker run --rm -v $(pwd):/app pass-craft:latest --file passwords.example.md --save passwords.example.md



# 系统调试
# alpine系统是否有sh
# uc-1: Dockerfile 使用CMD作为入口时
# docker run --rm pass-craft:alpine sh -c "if command -v sh >/dev/null; then echo 'sh 存在'; else echo 'sh 不存在'; fi"
# uc-2: Dockerfile 使用entrypoint作为入口时
docker run --rm --entrypoint="/bin/sh" pass-craft:alpine -c "if command -v sh >/dev/null; then echo 'sh 存在'; else echo 'sh 不存在'; fi"

# 用户是否有写入文件的权限
# docker run --rm -it --entrypoint="" pass-craft:alpine sh
docker run --rm --entrypoint="/bin/sh" pass-craft:alpine -c "echo > passwords.example.md;ls"
# echo "name:john,email:john@gmail.com,site:john.com,;method:sha512,cut:8,end:+,upper-start:5" > passwords.example.md
# sh: can't create passwords.example.md: Permission denied
# docker history pass-craft:alpine
```

### linux musl 版
```bash
bin="dist/x86_64-unknown-linux-musl/pass-craft";

$bin --help
$bin --version
$bin --show-platform
$bin --show-config

$bin --file passwords.example.md --save passwords.example.md --show-config
```

### window gnu 版
```powershell
$bin=".\dist\x86_64-pc-windows-gnu\pass-craft.exe";
& $bin --help
& $bin --version
& $bin --show-platform
& $bin --show-config
& $bin --file passwords.example.md --save passwords.example.md --show-config
```

### window msvc 版
```powershell
$bin=".\dist\x86_64-pc-windows-msvc\pass-craft.exe";
```