# 基础层：系统依赖
FROM rust:1.90-alpine3.20 AS base
RUN sed -i 's|dl-cdn.alpinelinux.org|mirrors.aliyun.com|g' /etc/apk/repositories
RUN apk update && apk add --no-cache \
    git \
    gcc \
    musl-dev \
    openssl-dev \
    build-base \
    pkgconfig \
    openssl-libs-static \
    bash \
    curl \
    vim \
    htop \
    file

# 依赖层：Rust依赖缓存
FROM base AS deps
WORKDIR /app
COPY .cargo/ .cargo/
COPY Cargo.toml ./
RUN mkdir -p src && \
    echo "fn main() {println!(\"dev\")}" > src/main.rs && \
    cargo fetch && \
    rm -rf src

# 开发层：添加开发工具
FROM base AS development
WORKDIR /app
COPY --from=deps /app/.cargo .cargo/
COPY --from=deps /usr/local/cargo /usr/local/cargo/
RUN cargo install cargo-watch

# 复制源代码
COPY . .

CMD ["cargo", "watch", "-x", "run"]


# 构建阶段
FROM rust:1.90-alpine3.20 AS builder

# 镜像源替换
RUN sed -i 's|dl-cdn.alpinelinux.org|mirrors.ustc.edu.cn|g' /etc/apk/repositories

RUN apk update && apk add --no-cache \
    git \
    gcc \
    musl-dev \
    openssl-dev \
    build-base \
    pkgconfig \
    openssl-libs-static \
    upx \
    file

WORKDIR /app

# 先复制 Cargo 配置文件
COPY .cargo/ .cargo/
COPY Cargo.toml Cargo.lock ./

# 创建假的 src 目录来缓存依赖
RUN mkdir -p src && \
    echo "fn main() {}" > src/main.rs && \
    echo "// dummy lib" > src/lib.rs

# 构建依赖（缓存层）
RUN cargo build --release --target x86_64-unknown-linux-musl

# 现在复制真正的源代码
COPY src/ src/

# 清理假的 main.rs 并重新构建
RUN rm -f target/x86_64-unknown-linux-musl/release/deps/pass_craft-* && \
    cargo build --release --target x86_64-unknown-linux-musl

# 移除调试符号并压缩
RUN strip /app/target/x86_64-unknown-linux-musl/release/pass-craft
RUN upx --best --lzma /app/target/x86_64-unknown-linux-musl/release/pass-craft

# 查看优化后的大小
RUN echo "=== 优化后的文件大小 ===" && \
    ls -lh /app/target/x86_64-unknown-linux-musl/release/pass-craft && \
    du -h /app/target/x86_64-unknown-linux-musl/release/pass-craft  && \
    echo "=== 检查二进制文件信息 ===" && \
    file /app/target/x86_64-unknown-linux-musl/release/pass-craft && \
    echo "=== 检查是否静态链接 ===" && \
    ldd /app/target/x86_64-unknown-linux-musl/release/pass-craft 2>&1 | head -5

# 最终运行阶段
FROM alpine:3.20
RUN sed -i 's|dl-cdn.alpinelinux.org|mirrors.ustc.edu.cn|g' /etc/apk/repositories
RUN apk update && apk add --no-cache ca-certificates tzdata

RUN adduser -D -u 1000 appuser
WORKDIR /app
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/pass-craft /app/

RUN chown appuser:appuser /app/pass-craft && chmod +x /app/pass-craft
USER appuser

ENTRYPOINT ["/app/pass-craft"]